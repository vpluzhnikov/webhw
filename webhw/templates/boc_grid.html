<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
{% load i18n %}

<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Форма БОц</title>
    <link rel="stylesheet" href="{{MEDIA_URL}}/css/slick.grid.css" type="text/css"/>
    <link rel="stylesheet" href="{{MEDIA_URL}}/css/jquery-ui-1.8.16.custom.css" type="text/css"/>
    <link rel="stylesheet" href="{{MEDIA_URL}}/css/examples.css" type="text/css"/>
    <style>
        .cell-title {
            font-weight: bold;
        }

        .cell-effort-driven {
            text-align: center;
        }
    </style>
</head>
<body>
<div style="position:relative">
    <div style="width:900px;">
        <div id="myGrid" style="width:100%;height:500px;"></div>
    </div>

    <script src="{{MEDIA_URL}}/js/lib/firebugx.js"></script>

    <script src="{{MEDIA_URL}}/js/lib/jquery-1.7.min.js"></script>
    <script src="{{MEDIA_URL}}/js/lib/jquery-ui-1.8.16.custom.min.js"></script>
    <script src="{{MEDIA_URL}}/js/lib/jquery.event.drag-2.0.min.js"></script>

    <script src="{{MEDIA_URL}}/js/slick.core.js"></script>
    <script src="{{MEDIA_URL}}/js/plugins/slick.cellrangedecorator.js"></script>
    <script src="{{MEDIA_URL}}/js/plugins/slick.cellrangeselector.js"></script>
    <script src="{{MEDIA_URL}}/js/plugins/slick.cellselectionmodel.js"></script>
    <script src="{{MEDIA_URL}}/js/slick.formatters.js"></script>
    <script src="{{MEDIA_URL}}/js/slick.editors.js"></script>
    <script src="{{MEDIA_URL}}/js/slick.grid.js"></script>

    <script>
        var columns = []
        var griddata = []
        var options = {
        }


        function requiredFieldValidator(value) {
            if (value == null || value == undefined || !value.length) {
                return {valid: false, msg: "This is a required field"};
            } else {
                return {valid: true, msg: null};
            }
        }

        function SelectCellEditor(args) {
            var $select;
            var defaultValue;
            var scope = this;

            this.init = function () {

                if (args.column.options) {
                    opt_values = args.column.options.split(',');
                } else {
                    opt_values = "yes,no".split(',');
                }
                option_str = ""
                for (i in opt_values) {
                    v = opt_values[i];
                    option_str += "<OPTION value='" + v + "'>" + v + "</OPTION>";
                }
                $select = $("<SELECT tabIndex='0' class='editor-select'>" + option_str + "</SELECT>");
                $select.appendTo(args.container);
                $select.focus();
            };

            this.destroy = function () {
                $select.remove();
            };

            this.focus = function () {
                $select.focus();
            };

            this.loadValue = function (item) {
                defaultValue = item[args.column.field];
                $select.val(defaultValue);
            };

            this.serializeValue = function () {
                if (args.column.options) {
                    return $select.val();
                } else {
                    return ($select.val() == "yes");
                }
            };

            this.applyValue = function (item, state) {
                item[args.column.field] = state;
            };

            this.isValueChanged = function () {
                return ($select.val() != defaultValue);
            };

            this.validate = function () {
                return {
                    valid: true,
                    msg: null
                };
            };

            this.init();
        }

        var grid;
        var url = "/boc_setup"

        $.ajax({
            url: url,
            async: false,
            dataType: 'json',
            success: function(data, status){
                console.log(data)
                griddata = data.data;
                columns = data.columns;
                options = data.options;

            }
        });


        $(function () {
{#            $.getJSON(url, {}, function(data, status){#}
{#                console.log(data)#}
{#                griddata = data.data;#}
{#                columns = data.columns;#}
{#                options = data.options;#}
{##}
{#            })#}

            console.log("DATA: " + griddata);
            console.log("COLUMNS: " + columns);
            console.log("OPTIONS: " + options);

            for (col in columns) {
                console.log(col)
                d = columns[col]
                if (d["editor"] == "Slick.Editors.Text") {
                    d["editor"] = Slick.Editors.Text
                }
                if (d["validator"] == "requiredFieldValidator") {
                    d["validator"] = requiredFieldValidator
                }
                if (d["editor"] == "SelectCellEditor") {
                    d["editor"] = SelectCellEditor
                }
                columns[col] = d
            }
            console.log(columns);


                for (var i = 0; i < 5; i++) {
                    var d = (griddata[i] = {});

                    d["code"] = "Task"+i;
                    d["name"] = "This is a sample task";
                    d["choice"] = "Black";

                }


            grid = new Slick.Grid("#myGrid", griddata, columns, options);
            grid.setSelectionModel(new Slick.CellSelectionModel());

            grid.onAddNewRow.subscribe(function (e, args) {
                var item = args.item;
                grid.invalidateRow(griddata.length);
                griddata.push(item);
                grid.updateRowCount();
                grid.render();
            });
        })
    </script>
</div>
</body>
</html>
