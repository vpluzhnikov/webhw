<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
{% load i18n %}

<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Форма БОц</title>
    <link rel="stylesheet" href="{{MEDIA_URL}}/css/slick.grid.css" type="text/css"/>
    <link rel="stylesheet" href="{{MEDIA_URL}}/css/jquery-ui-1.8.16.custom.css" type="text/css"/>
    <link rel="stylesheet" href="{{MEDIA_URL}}/css/examples.css" type="text/css"/>
    <style>
        .cell-title {
            font-weight: bold;
        }

        .cell-effort-driven {
            text-align: center;
        }
    </style>
</head>
<body>

{{ form.as_table }}

<div style="position:relative">
    <div style="width:1200px;">
        <div id="myGrid" style="width:100%;height:500px;"></div>
    </div>
    <ul id="contextMenu" style="position: absolute; top: 260px; left: 237px; display: none; ">
        <li data="Delete">Удалить</li>
    </ul>

    <script src="{{MEDIA_URL}}/js/lib/firebugx.js"></script>

    <script src="{{MEDIA_URL}}/js/lib/jquery-1.7.min.js"></script>
    <script src="{{MEDIA_URL}}/js/lib/jquery-ui-1.8.16.custom.min.js"></script>
    <script src="{{MEDIA_URL}}/js/lib/jquery.event.drag-2.0.min.js"></script>

    <script src="{{MEDIA_URL}}/js/slick.core.js"></script>
    <script src="{{MEDIA_URL}}/js/plugins/slick.cellrangedecorator.js"></script>
    <script src="{{MEDIA_URL}}/js/plugins/slick.cellrangeselector.js"></script>
    <script src="{{MEDIA_URL}}/js/plugins/slick.cellselectionmodel.js"></script>
    <script src="{{MEDIA_URL}}/js/slick.formatters.js"></script>
    <script src="{{MEDIA_URL}}/js/slick.editors.js"></script>
    <script src="{{MEDIA_URL}}/js/slick.grid.js"></script>

    <script>
        var columns = []
        var griddata = []
        var options = {
        }
        var colnumbers = { 'itemtype1' : 0,
                    'itemname' : 1,
                    'itemtype2' : 2,
                    'servername': 3,
                    'ex_cpucount' : 4,
                    'ex_ramcount' : 5,
                    'ex_sancount' : 6 ,
                    'ex_nascount': 7,
                    'cpucount' : 8,
                    'ramcount' : 9,
                    'sancount' : 10,
                    'nascount' : 11,
                    'itemcount' : 12,
                    'platformtype' : 13,
                    'ostype' : 14,
                    'swaddons' : 15,
                    'itemstate' : 16,
                    'lansegment' : 17,
                    'dbtype' : 18,
                    'clustype' : 19,
                    'backuptype' : 20,
                    'comment' : 21
        }


        function requiredFieldValidator(value) {
            if (value == null || value == undefined || !value.length) {
                return {valid: false, msg: "This is a required field"};
            } else {
                return {valid: true, msg: null};
            }
        }

        function SelectCellEditor(args) {
            var $select;
            var defaultValue;
            var scope = this;

            this.init = function () {

                if (args.column.options) {
                    opt_values = args.column.options.split(',');
                } else {
                    opt_values = "yes,no".split(',');
                }
                option_str = ""
                for (i in opt_values) {
                    v = opt_values[i];
                    option_str += "<OPTION value='" + v + "'>" + v + "</OPTION>";
                }
                $select = $("<SELECT tabIndex='0' class='editor-select'>" + option_str + "</SELECT>");
                $select.appendTo(args.container);
                $select.focus();
            };

            this.destroy = function () {
                $select.remove();
            };

            this.focus = function () {
                $select.focus();
            };

            this.loadValue = function (item) {
                defaultValue = item[args.column.field];
                $select.val(defaultValue);
            };

            this.serializeValue = function () {
                if (args.column.options) {
                    return $select.val();
                } else {
                    return ($select.val() == "yes");
                }
            };

            this.applyValue = function (item, state) {
                item[args.column.field] = state;
            };

            this.isValueChanged = function () {
                return ($select.val() != defaultValue);
            };

            this.validate = function () {
                return {
                    valid: true,
                    msg: null
                };
            };

            this.init();
        }

        var grid;
        var url = "/boc_setup"

        $.ajax({
            url: url,
            async: false,
            dataType: 'json',
            success: function(data, status){
{#                console.log(data)#}
                griddata = data.data;
                columns = data.columns;
                options = data.options;

            }
        });

        $(function () {
{#            $.getJSON(url, {}, function(data, status){#}
{#                console.log(data)#}
{#                griddata = data.data;#}
{#                columns = data.columns;#}
{#                options = data.options;#}
{##}
{#            })#}

{#            console.log("DATA: " + griddata);#}
{#            console.log("COLUMNS: " + columns);#}
{#            console.log("OPTIONS: " + options);#}

            for (col in columns) {
                d = columns[col]
                if (d["editor"] == "Slick.Editors.Text") {
                    d["editor"] = Slick.Editors.Text
                }
                if (d["validator"] == "requiredFieldValidator") {
                    d["validator"] = requiredFieldValidator
                }
                if (d["editor"] == "SelectCellEditor") {
                    d["editor"] = SelectCellEditor
                }
                if (d["editor"] == "Slick.Editors.LongText") {
                    d["editor"] = Slick.Editors.LongText
                }

                columns[col] = d
            }

            grid = new Slick.Grid("#myGrid", griddata, columns, options);
            grid.setSelectionModel(new Slick.CellSelectionModel());
            grid.onContextMenu.subscribe(function (e) {
                e.preventDefault();
                var cell = grid.getCellFromEvent(e);
                $("#contextMenu")
                        .data("row", cell.row)
                        .css("top", e.pageY)
                        .css("left", e.pageX)
                        .show();

                $("body").one("click", function () {
                    $("#contextMenu").hide();
                });
            });

{#            grid.onClick.subscribe(function (e) {#}
{#                var cell = grid.getCellFromEvent(e);#}
{#                if (grid.getColumns()[cell.cell].id == "priority") {#}
{#                    if (!grid.getEditorLock().commitCurrentEdit()) {#}
{#                        return;#}
{#                    }#}
{##}
{#                    var states = { "Low": "Medium", "Medium": "High", "High": "Low" };#}
{#                    data[cell.row].priority = states[data[cell.row].priority];#}
{#                    grid.updateRow(cell.row);#}
{#                    e.stopPropagation();#}
{#                }#}
{#            });#}

        $("#contextMenu").click(function (e) {
            if (!$(e.target).is("li")) {
                return;
            }
            if (!grid.getEditorLock().commitCurrentEdit()) {
                return;
            }
            var row = $(this).data("row");
            console.log(row);
{#            data[row].priority = $(e.target).attr("data");#}
            griddata.splice(row, 1);
            grid.invalidate();
            grid.render();
        });



            grid.onCellChange.subscribe(function(e,args) {
                grid.invalidateRow(args.row);
                if (grid.getColumns()[args.cell].field == "itemtype1") {
                    if (!griddata[args.row][grid.getColumns()[colnumbers["itemname"]].field] || griddata[args.row][grid.getColumns()[colnumbers["itemname"]].field] == "") {
                        griddata[args.row][grid.getColumns()[colnumbers["itemname"]].field] = griddata[args.row][grid.getColumns()[colnumbers["itemtype1"]].field];
                    }
                }
                if (grid.getColumns()[args.cell].field == "itemtype2") {
                    if (griddata[args.row][grid.getColumns()[colnumbers["itemtype2"]].field] == "новая позиция"){
                        griddata[args.row][grid.getColumns()[colnumbers["servername"]].field] = "-";
                        griddata[args.row][grid.getColumns()[colnumbers["ex_cpucount"]].field] = "-";
                        griddata[args.row][grid.getColumns()[colnumbers["ex_ramcount"]].field] = "-";
                        griddata[args.row][grid.getColumns()[colnumbers["ex_sancount"]].field] = "-";
                        griddata[args.row][grid.getColumns()[colnumbers["ex_nascount"]].field] = "-";
                        if (griddata[args.row][grid.getColumns()[colnumbers["itemtype1"]].field] == "Сервер приложения"){
                            griddata[args.row][grid.getColumns()[colnumbers["cpucount"]].field] = 6;
                            griddata[args.row][grid.getColumns()[colnumbers["ramcount"]].field] = 48;
                            griddata[args.row][grid.getColumns()[colnumbers["sancount"]].field] = 0;
                            griddata[args.row][grid.getColumns()[colnumbers["nascount"]].field] = 0;
                            griddata[args.row][grid.getColumns()[colnumbers["platformtype"]].field] = "Intel x86";
                            griddata[args.row][grid.getColumns()[colnumbers["ostype"]].field] = "Linux (RHEL)";
                        }
                        if (griddata[args.row][grid.getColumns()[colnumbers["itemtype1"]].field] == "Терминальный сервер"){
                            griddata[args.row][grid.getColumns()[colnumbers["cpucount"]].field] = 4;
                            griddata[args.row][grid.getColumns()[colnumbers["ramcount"]].field] = 24;
                            griddata[args.row][grid.getColumns()[colnumbers["sancount"]].field] = 0;
                            griddata[args.row][grid.getColumns()[colnumbers["nascount"]].field] = 0;
                            griddata[args.row][grid.getColumns()[colnumbers["platformtype"]].field] = "Intel x86";
                            griddata[args.row][grid.getColumns()[colnumbers["ostype"]].field] = "Windows";

                        }
                        if (griddata[args.row][grid.getColumns()[colnumbers["itemtype1"]].field] == "Балансировщик"){
                            griddata[args.row][grid.getColumns()[colnumbers["cpucount"]].field] = "-";
                            griddata[args.row][grid.getColumns()[colnumbers["ramcount"]].field] = "-";
                            griddata[args.row][grid.getColumns()[colnumbers["sancount"]].field] = "-";
                            griddata[args.row][grid.getColumns()[colnumbers["nascount"]].field] = "-";
                        }
                        if (griddata[args.row][grid.getColumns()[colnumbers["itemtype1"]].field] == "IBM DataPower"){
                            griddata[args.row][grid.getColumns()[colnumbers["cpucount"]].field] = "-";
                            griddata[args.row][grid.getColumns()[colnumbers["ramcount"]].field] = "-";
                            griddata[args.row][grid.getColumns()[colnumbers["sancount"]].field] = "-";
                            griddata[args.row][grid.getColumns()[colnumbers["nascount"]].field] = "-";
                        }

                    }
                }
                if (grid.getColumns()[args.cell].field == "platformtype") {
                    if (griddata[args.row][grid.getColumns()[colnumbers["platformtype"]].field] == "Intel x86"){
                        griddata[args.row][grid.getColumns()[colnumbers["ostype"]].field] = "Linux (RHEL)";
                    }
                    if (griddata[args.row][grid.getColumns()[colnumbers["platformtype"]].field] == "Oracle SPARC"){
                        griddata[args.row][grid.getColumns()[colnumbers["ostype"]].field] = "Oracle Solaris";
                    }
                    if (griddata[args.row][grid.getColumns()[colnumbers["platformtype"]].field] == "IBM Power"){
                        griddata[args.row][grid.getColumns()[colnumbers["ostype"]].field] = "IBM AIX";
                    }
                }

                if (grid.getColumns()[args.cell].field == "ostype") {
                    if (griddata[args.row][grid.getColumns()[colnumbers["ostype"]].field] == "Linux (RHEL)" ||
                            griddata[args.row][grid.getColumns()[colnumbers["ostype"]].field] == "Windows"){
                        griddata[args.row][grid.getColumns()[colnumbers["platformtype"]].field] = "Intel x86";
                    }
                    if (griddata[args.row][grid.getColumns()[colnumbers["ostype"]].field] == "Oracle Solaris"){
                        griddata[args.row][grid.getColumns()[colnumbers["platformtype"]].field] = "Oracle SPARC";
                    }
                    if (griddata[args.row][grid.getColumns()[colnumbers["ostype"]].field] == "IBM AIX"){
                        griddata[args.row][grid.getColumns()[colnumbers["platformtype"]].field] = "IBM Power";
                    }
                }

                if (grid.getColumns()[args.cell].field == "itemstate") {
                    if (griddata[args.row][grid.getColumns()[colnumbers["itemstate"]].field] == "пром") {
                        griddata[args.row][grid.getColumns()[colnumbers["clustype"]].field] = "да";
                        griddata[args.row][grid.getColumns()[colnumbers["backuptype"]].field] = "да";
                    }
                    if (griddata[args.row][grid.getColumns()[colnumbers["itemstate"]].field] == "тест"){
                        griddata[args.row][grid.getColumns()[colnumbers["clustype"]].field] = "нет";
                        griddata[args.row][grid.getColumns()[colnumbers["backuptype"]].field] = "нет";
                    }
                }

                grid.render();
            });


            grid.onAddNewRow.subscribe(function (e, args) {
                var item = args.item;
                console.log("from new row handler");
                console.log(item);
                console.log(args);
                if (args["column"]["id"] == "itemtype1") {
                    item["itemname"] = item["itemtype1"];
                }
                if (args["column"]["id"] == "itemtype2") {
                    if (item["itemtype2"] == "новая позиция") {
                        item["servername"] = "-";
                        item["ex_cpucount"] = "-";
                        item["ex_ramcount"] = "-";
                        item["ex_sancount"] = "-";
                        item["ex_nascount"] = "-";
                    }
                }
                if (args["column"]["id"] == "platformtype") {
                    if (item["platformtype"] == "Intel x86"){
                        item["ostype"] = "Linux (RHEL)";
                    }
                    if (item["platformtype"] == "Oracle SPARC"){
                        item["ostype"] = "Oracle Solaris";
                    }
                    if (item["platformtype"] == "IBM Power"){
                        item["ostype"] = "IBM AIX";
                    }
                }

                if (args["column"]["id"] == "ostype") {
                    if (item["ostype"] == "Linux (RHEL)" || item["ostype"] == "Windows" ){
                        item["platformtype"] = "Intel x86";
                    }
                    if (item["ostype"] == "Oracle Solaris"){
                        item["platformtype"] = "Oracle SPARC";
                    }
                    if (item["ostype"] == "IBM AIX"){
                        item["platformtype"] = "IBM Power";
                    }
                }

                if (args["column"]["id"] == "itemstate") {
                    if (item["itemstate"] == "пром"){
                        item["clustype"] = "да";
                        item["backuptype"] = "да";
                    }
                    if (item["itemstate"] == "тест"){
                        item["clustype"] = "нет";
                        item["backuptype"] = "нет";
                    }
                }

                grid.invalidateRow(griddata.length);
                griddata.push(item);
                grid.updateRowCount();
                grid.render();
            });
        })

        var prjselectbox = document.getElementById('id_prjselect')
        var prjname = document.getElementById('id_prjname')
        var prjcustomer = document.getElementById('id_customer')
        var prjmanager = document.getElementById('id_manager')

        var prjselect_handler=function () {
            var url_get_prj_name = "/boc_get_prj_name"
            $.ajax({
                url: url_get_prj_name,
                async: false,
                dataType: 'json',
                data: { "project_id" : prjselectbox.value },
                success: function(data, status){
{#                    console.log(data)#}
                    prjname.value = data.project_name;
                    prjcustomer.value = data.customer;
                    prjmanager.value = data.manager;
                }
            });
        };
        prjselectbox.onchange=prjselect_handler


    </script>
</div>
</body>
</html>
